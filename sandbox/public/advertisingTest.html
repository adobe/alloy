<!doctype html>
<html>
  <head>
    <title>Advertising Test</title>
    <style>
      body {
        font-family: Arial;
        padding: 20px;
      }
      button {
        padding: 10px;
        margin: 5px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 3px;
      }
      .result {
        background: #f8f9fa;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ddd;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>Alloy Advertising Test</h1>

    <div>
      <label>Handle Advertising Data:</label>
      <select id="config">
        <option value="auto">auto</option>
        <option value="auto">wait</option>
        <option value="disabled">disabled</option>
      </select>
    </div>

    <div>
      <button onclick="sendEvent('web.webpagedetails.pageViews')">
        Page View
      </button>
      <button onclick="sendEvent('commerce.purchases')">Purchase</button>
      <button onclick="clear()">Clear</button>
    </div>

    <div id="results"></div>

    <script>
      // Clear any existing setup and start fresh
      delete window.__alloyNS;
      delete window.alloy;

      // Initialize properly
      window.__alloyNS = ["alloy"];
      window.alloy = function () {
        var args = arguments;
        return new Promise(function (resolve, reject) {
          window.alloy.q = window.alloy.q || [];
          window.alloy.q.push([resolve, reject, args]);
        });
      };

      console.log("Base code initialized, __alloyNS:", window.__alloyNS);
    </script>
    <script src="/alloy.js"></script>
    <script>
      setTimeout(() => {
        alloy("configure", {
          datastreamId: "bc1a10e0-aee4-4e0e-ac5b-cdbb9abbec83",
          orgId: "5BFE274A5F6980A50A495C08@AdobeOrg",
          debugEnabled: true,
          defaultConsent: "in",
          advertising: {
            id5PartnerId: 1650,
            rampIdJSPath:
              "https://cdn.jsdelivr.net/npm/ramp-id@1.0.0/ramp-id.min.js",
            dspEnabled: true,
            advertiserSettings: [
              {
                advertiserId: "test-advertiser-1",
                enabled: true,
              },
            ],
          },
        });
        console.log("Alloy configured with advertising");
      }, 500);

      let counter = 0;

      async function sendEvent(type) {
        try {
          const config = document.getElementById("config").value;
          const data = {
            xdm: {
              eventType: type,
              web: { webPageDetails: { URL: location.href } },
            },
          };
          if (config !== "disabled") {
            data.advertising = { handleAdvertisingData: config };
          }
          const result = await alloy("sendEvent", data);
          counter++;
          document.getElementById("results").innerHTML +=
            `<div class="result"><h4>Event ${counter}: ${type}</h4><pre>${JSON.stringify(result, null, 2)}</pre></div>`;
        } catch (e) {
          counter++;
          document.getElementById("results").innerHTML +=
            `<div class="result"><h4>Error ${counter}</h4><pre>${e.message}</pre></div>`;
        }
      }

      function clear() {
        document.getElementById("results").innerHTML = "";
        counter = 0;
      }
    </script>
  </body>
</html>
