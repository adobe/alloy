name: Changeset Beta Merge Guard

on:
  pull_request:
    branches:
      - main

concurrency: changeset-beta-merge-guard-${{ github.event.pull_request.number }}

permissions:
  contents: read
  pull-requests: read

jobs:
  block_changesets_in_beta:
    name: Block changesets in beta
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR HEAD
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Determine if base branch is in beta prerelease mode
        id: beta
        run: |
          set -u
          git fetch origin "${{ github.base_ref }}" --depth=1

          PRE_JSON="$(git show "origin/${{ github.base_ref }}:.changeset/pre.json" 2>/dev/null || true)"
          MODE=""
          TAG=""
          if [ -n "${PRE_JSON}" ]; then
            MODE="$(printf '%s' "${PRE_JSON}" | jq -r '.mode // ""')"
            TAG="$(printf '%s' "${PRE_JSON}" | jq -r '.tag // ""')"
          fi

          if [ "${MODE}" = "pre" ] && [ "${TAG}" = "beta" ]; then
            echo "is_beta=true" >> "${GITHUB_OUTPUT}"
          else
            echo "is_beta=false" >> "${GITHUB_OUTPUT}"
          fi

      - name: Fail if PR includes changeset files while in beta
        if: steps.beta.outputs.is_beta == 'true'
        run: |
          set -u
          git fetch origin "${{ github.base_ref }}" --depth=1
          CHANGED_FILES="$(git diff --name-only "origin/${{ github.base_ref }}...HEAD")"

          # Changeset files are markdown files in the root of the `.changeset/` directory.
          OFFENDING="$(printf '%s\n' "${CHANGED_FILES}" | grep -E '^\.changeset/[^/]+\.md$' || true)"

          if [ -n "${OFFENDING}" ]; then
            echo "::error::This repo is in beta prerelease mode. PRs must not include changeset files (.changeset/*.md). Offending files:"
            printf '%s\n' "${OFFENDING}"
            exit 1
          fi

          echo "OK: base branch is beta, and PR does not include changeset files."
