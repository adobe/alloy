name: Dev
on: push
env:
  BROWSERSTACK_ACCESS_KEY: "${{ secrets.BROWSERSTACK_ACCESS_KEY }}"
  BROWSERSTACK_USERNAME: "${{ secrets.BROWSERSTACK_USERNAME }}"
  BROWSERSTACK_DEBUG: 'true'
  BROWSERSTACK_NETWORK_LOGS: 'true'
  BROWSERSTACK_CONSOLE: 'info'
  EDGE_BASE_PATH: "ee-pre-prd"
  ALLOY_ENV: "int"

jobs:
  alloy-dev-test:
    name: "Run Unit & E2E Test"
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        browser: ["browserstack:chrome@87","browserstack:firefox@85","browserstack:ie@11","browserstack:safari@14.0"]
    steps:
    - uses: actions/checkout@v2
    - name: Serialize workflow runs
      uses: softprops/turnstyle@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - uses: actions/cache@v2
      id: npm-cache
      with:
        path: '**/node_modules'
        key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}
    - name: Install dependencies
      if: steps.npm-cache.outputs.cache-hit != 'true'
      run: npm ci
    - name: Build
      run: npm run test:functional:ci:build
    - name: Unit Test
      run: npm run test:unit:browserstack:ci
    - name: Functional e2e Tests
      run: |
        npx testcafe ${{ matrix.browser }} test/functional/specs/Audiences/*.js,
        npx testcafe ${{ matrix.browser }} test/functional/specs/CNAME/*.js
        npx testcafe ${{ matrix.browser }} test/functional/specs/Command\ Logic/*.js
        npx testcafe ${{ matrix.browser }} test/functional/specs/Context/*.js
        npx testcafe ${{ matrix.browser }} test/functional/specs/Data\ Collector/*.js
        npx testcafe ${{ matrix.browser }} test/functional/specs/Identity/*.js
        npx testcafe ${{ matrix.browser }} test/functional/specs/ID\ Migration/*.js
        npx testcafe ${{ matrix.browser }} test/functional/specs/Install\ SDK/*.js
        npx testcafe ${{ matrix.browser }} test/functional/specs/Logging/*.js
        npx testcafe ${{ matrix.browser }} test/functional/specs/Personalization/*.js
        npx testcafe ${{ matrix.browser }} test/functional/specs/Privacy/*.js
        npx testcafe ${{ matrix.browser }} test/functional/specs/Visitor/*.js
    - name: Clear Browserstack Tunnels
      run: |
        chmod +x "${GITHUB_WORKSPACE}/scripts/clearBrowserStackJobs.sh"
        "${GITHUB_WORKSPACE}/scripts/clearBrowserStackJobs.sh"
