name: PR-Tests
on: pull_request
env:
  SAUCE_USERNAME: ${{ secrets.SAUCE_USERNAME }}
  SAUCE_ACCESS_KEY: ${{ secrets.SAUCE_ACCESS_KEY }}
  BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
  BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

jobs:
  unit-test-saucelabs:
    name: "Unit Test"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        ref: "${{github.event.pull_request.head.ref}}"
        repository: "${{github.event.pull_request.head.repo.full_name}}"
    - uses: actions/cache@v2
      id: node-cache
      with:
        path: '**/node_modules'
        key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}
    - name: Install dependencies
      if: steps.node-cache.outputs.cache-hit != 'true'
      run: npm ci
    - name: "Run Unit Test"
      run: npm run test:unit:saucelabs

  e2e-test:
    name: "E2E Tests using Saucelabs"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          ref: "${{github.event.pull_request.head.ref}}"
          repository: "${{github.event.pull_request.head.repo.full_name}}"
      - uses: actions/cache@v2
        id: node-cache
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}
      - uses: saucelabs/sauce-connect-action@master
        with:
          username: ${{ secrets.SAUCE_USERNAME }}
          accessKey: ${{ secrets.SAUCE_ACCESS_KEY }}
          tunnelIdentifier: github-action-tunnel
      - name: Install dependencies
        if: steps.node-cache.outputs.cache-hit != 'true'
        run: npm ci
      - name: Build
        run: npm run build
      - name: Test
        run: npm run test:functional
  
  #Using Browserstack to run functional tests on IE 11. SauceLabs times out on IE tests.
  e2e-test-browserstack:
    name: "E2E Tests using BrowserStack"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        ref: "${{github.event.pull_request.head.ref}}"
        repository: "${{github.event.pull_request.head.repo.full_name}}"
    - uses: actions/cache@v2
      id: node-cache
      with:
        path: '**/node_modules'
        key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}
    - name: Install dependencies
      if: steps.node-cache.outputs.cache-hit != 'true'
      run: npm ci
    - name: Build
      run: npm run build
    - name: 'BrowserStackLocal Setup'
      uses: 'browserstack/github-actions/setup-local@master'
      with:
        local-testing: start
        local-identifier: random
    - name: Test IE 11 on Windows 10
      run: |
        npm run test:functional:ci
    - name: 'BrowserStackLocal Stop'
      uses: 'browserstack/github-actions/setup-local@master'
      with:
        local-testing: stop

  build-head:
    name: "Build"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          ref: "master"
      - name: Use Node.js 12.x
        uses: actions/setup-node@v1
        with:
          node-version: 12.x
      - uses: actions/cache@v2
        id: node-cache
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}
      - name: Install dependencies
        if: steps.node-cache.outputs.cache-hit != 'true'
        run: npm ci
      - name: Build
        run: npm run build
      - name: Upload bundle-stats.json
        uses: actions/upload-artifact@v1
        with:
          name: head-stats
          path: bundle-stats.json

  build-base:
    name: "Build base"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        ref: "${{github.event.pull_request.base.ref}}"
        repository: "${{github.event.pull_request.base.repo.full_name}}"
    - name: Use Node.js 12.x
      uses: actions/setup-node@v1
      with:
        node-version: 12.x
    - uses: actions/cache@v2
      id: node-cache
      with:
        path: "**/node_modules"
        key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}
    - name: Install dependencies
      if: steps.node-cache.outputs.cache-hit != 'true'
      run: npm ci
    - name: Build
      run: npm run build
    - name: Upload bundle-stats.json
      uses: actions/upload-artifact@v1
      with:
        name: base-stats
        path: bundle-stats.json

  compare:
    name: "Compare base & head bundle sizes"
    runs-on: ubuntu-latest
    needs: [build-base, build-head]
    steps:
    - uses: actions/checkout@v1
    - name: Download base artifact
      uses: actions/download-artifact@v1
      with:
        name: base-stats
    - name: Download head artifact
      uses: actions/download-artifact@v1
      with:
        name: head-stats
    - name: Diff between base & head
      uses: weltenwort/webpack-stats-diff-action@v1.2.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        base_stats_path: base-stats/bundle-stats.json
        head_stats_path: head-stats/bundle-stats.json