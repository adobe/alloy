name: PR-Tests
#Targetting this branch temporarily 
on:
  push:
    branches:
      - github-actions
env:
  SAUCE_USERNAME: ${{ secrets.SAUCE_USERNAME }}
  SAUCE_ACCESS_KEY: ${{ secrets.SAUCE_ACCESS_KEY }}

jobs:
  unit-test-saucelabs:
    name: "Unit Test"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        ref: "${{github.event.pull_request.head.ref}}"
        repository: "${{github.event.pull_request.head.repo.full_name}}"
    - uses: actions/cache@v2
      id: node-cache
      with:
        path: '**/node_modules'
        key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}
    - name: Install dependencies
      if: steps.node-cache.outputs.cache-hit != 'true'
      run: npm ci
    - name: "Run Unit Test"
      run: npm run test:unit:saucelabs

# https://github.com/saucelabs/testrunner-toolkit/blob/master/docs/github-actions.md
  # e2e-test:
  #   runs-on: ubuntu-latest
  #   container:
  #     image: saucelabs/stt-testcafe-node:latest
  #     options: --user 1001
  #   steps:
  #   - uses: actions/checkout@v2
  #     with:
  #       ref: "${{github.event.pull_request.head.ref}}"
  #       repository: "${{github.event.pull_request.head.repo.full_name}}"
  #   - uses: actions/cache@v2
  #     id: node-cache
  #     with:
  #       path: '**/node_modules'
  #       key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}
  #   - name: Install dependencies
  #     if: steps.node-cache.outputs.cache-hit != 'true'
  #     run: npm ci
  #   - name: Run Sauce Pipeline Test
  #     run: |
  #       EDGE_BASE_PATH=\"ee-pre-prd\" ALLOY_ENV=\"int\" saucectl run -c ./.sauce/testcafe.yml
  #     env:
  #       BUILD_ID: ${{ github.run_id }}
  #       BUILD_ENV: GitHub Actions
  #       EDGE_BASE_PATH: "ee-pre-prd" 
  #       ALLOY_ENV: "int"

  e2e-test-browserstack:
    name: "E2E Tests BrowserStack"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        ref: "${{github.event.pull_request.head.ref}}"
        repository: "${{github.event.pull_request.head.repo.full_name}}"
    - uses: actions/cache@v2
      id: npm-cache
      with:
        path: '**/node_modules'
        key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}
    - name: Install dependencies
      if: steps.npm-cache.outputs.cache-hit != 'true'
      run: npm ci
    - name: Build
      run: npm run build
    - name: 'BrowserStack Env Setup'
      uses: 'browserstack/github-actions/setup-env@master'
      with:
        username:  ${{ secrets.BROWSERSTACK_USERNAME }}
        access-key: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
    - name: 'BrowserStackLocal Setup'
      uses: 'browserstack/github-actions/setup-local@master'
      with:
        local-testing: start
        local-identifier: random
    # https://markus.oberlehner.net/blog/dealing-with-the-browserstack-parallel-test-limit-when-using-testcafe/ http-server
    # https://github.com/DevExpress/testcafe/issues/1330 Browser List
    # https://www.npmjs.com/package/testcafe-browser-provider-browserstack testcafe doc
    - name: Run TestCafe Tests
      run: |
        npm run test:functional:ci
    - name: 'BrowserStackLocal Stop'
      uses: 'browserstack/github-actions/setup-local@master'
      with:
        local-testing: stop
  
  #Using Browserstack to run functional tests on IE 11. SauceLabs times out on IE tests.
  # e2e-test-browserstack:
  #   name: "E2E Tests using BrowserStack"
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v2
  #     with:
  #       ref: "${{github.event.pull_request.head.ref}}"
  #       repository: "${{github.event.pull_request.head.repo.full_name}}"
  #   - uses: actions/cache@v2
  #     id: node-cache
  #     with:
  #       path: '**/node_modules'
  #       key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}
  #   - name: Install dependencies
  #     if: steps.node-cache.outputs.cache-hit != 'true'
  #     run: npm ci
  #   - name: Build
  #     run: npm run build
  #   - name: 'BrowserStackLocal Setup'
  #     uses: 'browserstack/github-actions/setup-local@master'
  #     with:
  #       local-testing: start
  #       local-identifier: random
  #   - name: Test IE 11 on Windows 10
  #     run: |
  #       npm run test:functional:ci
  #   - name: 'BrowserStackLocal Stop'
  #     uses: 'browserstack/github-actions/setup-local@master'
  #     with:
  #       local-testing: stop

  # build-head:
  #   name: "Build"
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v2
  #       with:
  #         ref: "master"
  #     - name: Use Node.js 12.x
  #       uses: actions/setup-node@v1
  #       with:
  #         node-version: 12.x
  #     - uses: actions/cache@v2
  #       id: node-cache
  #       with:
  #         path: "**/node_modules"
  #         key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}
  #     - name: Install dependencies
  #       if: steps.node-cache.outputs.cache-hit != 'true'
  #       run: npm ci
  #     - name: Build
  #       run: npm run build
  #     - name: Upload bundle-stats.json
  #       uses: actions/upload-artifact@v1
  #       with:
  #         name: head-stats
  #         path: bundle-stats.json

  # build-base:
  #   name: "Build base"
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v2
  #     with:
  #       ref: "${{github.event.pull_request.base.ref}}"
  #       repository: "${{github.event.pull_request.base.repo.full_name}}"
  #   - name: Use Node.js 12.x
  #     uses: actions/setup-node@v1
  #     with:
  #       node-version: 12.x
  #   - uses: actions/cache@v2
  #     id: node-cache
  #     with:
  #       path: "**/node_modules"
  #       key: ${{ runner.os }}-modules-${{ hashFiles('**/package-lock.json') }}
  #   - name: Install dependencies
  #     if: steps.node-cache.outputs.cache-hit != 'true'
  #     run: npm ci
  #   - name: Build
  #     run: npm run build
  #   - name: Upload bundle-stats.json
  #     uses: actions/upload-artifact@v1
  #     with:
  #       name: base-stats
  #       path: bundle-stats.json

  # compare:
    # name: "Compare base & head bundle sizes"
    # runs-on: ubuntu-latest
    # needs: [build-base, build-head]
    # steps:
    # - uses: actions/checkout@v1
    # - name: Download base artifact
    #   uses: actions/download-artifact@v1
    #   with:
    #     name: base-stats
    # - name: Download head artifact
    #   uses: actions/download-artifact@v1
    #   with:
    #     name: head-stats
    # - name: Diff between base & head
    #   uses: weltenwort/webpack-stats-diff-action@v1.2.0
    #   with:
    #     token: ${{ secrets.GITHUB_TOKEN }}
    #     base_stats_path: base-stats/bundle-stats.json
    #     head_stats_path: head-stats/bundle-stats.json