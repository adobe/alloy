name: Prod
on:
  schedule:
    - cron: "0 */24 * * *"
  workflow_dispatch:
env:
  SAUCE_USERNAME: ${{ secrets.SAUCE_USERNAME }}
  SAUCE_ACCESS_KEY: ${{ secrets.SAUCE_ACCESS_KEY }}
  SAUCE_JOB: "Alloy Prod Workflow"
  SAUCE_CAPABILITIES_OVERRIDES_PATH: 'sauceLabsCapabilities.json'
  ALLOY_ENV: prod

jobs:
  alloy-prod-e2e:
    name: "Cron: Prod E2E Tests"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          # Fetch all the branches and tags in the repo
          fetch-depth: 0
      # install these dependencies so getTestingTags will work
      - run: npm install @octokit/rest semver
      - run: |
          for TAG in $(./scripts/getTestingTags.js)
          do
            git checkout tags/$TAG
            npm ci
            npm run test:functional:build:prod
            export ALLOY_PROD_VERSION=`node -e 'console.log(require("./package.json").version)'`
            npx testcafe -q -c 5 'saucelabs:Chrome@latest:macOS 11.00','saucelabs:IE@11.285:Windows 10','saucelabs:Firefox@latest:Windows 10','saucelabs:Safari@latest:macOS 11.00'
          done
        env:
          # getTestingTags calls the Github API so we need to use the token
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # - uses: craftech-io/slack-action@v1
      #   with:
      #     slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
      #     status: failure
      #   if: failure()
